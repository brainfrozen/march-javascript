define("common/Contract",[],function(){function e(e){var n=typeof e;return"function"===n||"object"===n&&!!e}function n(n){if(!e(n))return[];var t=[];for(var r in n)t.push(r);return t}function t(e,n){return function(t){var r=arguments.length;if(r<2||null==t)return t;for(var i=1;i<r;i++)for(var o=arguments[i],a=e(o),c=a.length,s=0;s<c;s++){var f=a[s];n&&void 0!==t[f]||(t[f]=o[f])}return t}}var r=t(n),i=t(n,!0),o=function(n){n&&e(n)&&i(this,n),this.initialize.apply(this,arguments)};r(o.prototype,{declare:[],initialize:function(){},clone:function(){},equals:function(e){if(this==e)return!0;if(void 0===e||null==e)return!1;if(e.constructor!=this.constructor)return!1;for(var n=this.declare,t=0;t<n.length;t++)if(this[n[t]]instanceof o){if(!this[n[t]].equals(e[n[t]]))return!1}else if(this[n[t]]!==e[n[t]])return!1;return!0}});var a=function(e,n){var t,i=this;t=e&&e.hasOwnProperty("constructor")?e.constructor:function(){return i.apply(this,arguments)},r(t,i,n);var o=function(){this.constructor=t};return o.prototype=i.prototype,t.prototype=new o,e&&r(t.prototype,e),t.__super__=i.prototype,t};return o.extend=a,o}),define("common/Events",["common/Contract"],function(e){return e.extend({on:function(e,n){if(n&&"function"==typeof n){var t=this.handlers||(this.handlers={});t=t[e]||(t[e]=[]),t.push(n)}return this},off:function(e,n){var t=this.handlers||(this.handlers={});if(n){if(t=t[e]){for(var r=-1,i=0;i<t.length;i++)if(t[i]==n){r=i;break}r>=0&&t.splice(r,1)}}else e?delete t[e]:this.handlers={};return this},trigger:function(e){var n=this.handlers||(this.handlers={});if(n=n[e])for(var t=0;t<n.length;t++)try{n[t].apply(this,Array.prototype.slice.call(arguments,1))}catch(e){}}})}),define("common/Util",function(){return{uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0;return("x"==e?n:3&n|8).toString(16)})}}}),define("data/Command",["common/Contract"],function(e){return e.extend()}),define("data/Constant",["data/Data"],function(e){return e.extend({declare:["value","type"]})}),define("data/Data",["common/Contract"],function(e){return e.extend()}),define("data/Model",["data/Pointer","data/command/Construct","data/command/Destruct","data/command/Insert","data/command/Delete","data/command/Set","data/command/Unset"],function(e,n,t,r,i,o,a){function c(e){return"object"==typeof e&&e instanceof Array}function s(e,n){switch(u(n)){case"HASH":return d(e,n);case"SEQUENCE":return f(e,n)}}function f(e,n){for(var t=[],i=0;i<n.length;i++)t.push(new Operation({pointer:e,command:new r({offset:i,data:n[i]})}));return t}function d(e,n){var t=[];for(var r in n)t.push(new Operation({pointer:e,command:new o({identifier:r,data:sequence[r]})}));return t}function u(e){if(void 0!==e&&null!=e)return e instanceof Array?"SEQUENCE":"HASH"}var m=function(){this._base=new e,this._memory={},this._memory[this._base.address]={}};return m.prototype.evaluate=function(){var e,s,f;arguments[0]instanceof Operation?(e=arguments[0].pointer,s=[arguments[0].command]):(e=arguments[0],s=Array.prototype.slice.call(arguments,1));var d;d=e?this._memory[e.address]:this._memory[this._base.address];for(var u=0;u<s.length;u++)if((f=s[u])instanceof n){if(d)throw new Error("DuplicateObjectException");switch(f.type){case"HASH":d={};break;case"SEQUENCE":d=[];break;default:throw new Error("UnknownTypeException")}this._memory[e.address]=d}else if(f instanceof t){if(!d)throw new Error("NoSuchObjectException");delete this._memory[e.address],d=null}else if(f instanceof r){if(!c(d))throw new Error("TypeException");d.splice(f.offset,0,f.data)}else if(f instanceof i){if(!c(d))throw new Error("TypeException");d.splice(f.offset,1)}else if(f instanceof o){if("object"!=typeof d)throw new Error("TypeException");d[f.identifier]=f.data}else if(f instanceof a){if("object"!=typeof d)throw new Error("TypeException");delete d[f.identifier]}else if(!f instanceof Nil)throw new Error("UnsupportedCommandException");return this},m.prototype.find=function(e,n){var t;if(void 0!==(t=e?this._memory[e.address]:this._memory[this._base.address])&&void 0!==n&&null!=n)return t[n]},m.prototype.getType=function(e){if(e){return u(this._memory[e.address])}},m.prototype.serialize=function(t){var r,i=this._memory;if(t)return r=i[t.address],s(t,r);var o=[];for(var a in i)r=i[a],t=a===this._base.address?null:new e({address:a}),t&&o.push(new Operation({pointer:t,command:new n({type:u(r)})})),o.concat(s(t,r));return o},m}),define("data/Operation",["common/Contract"],function(e){return e.extend({declare:["command","pointer"]})}),define("data/Pointer",["common/Util","data/Data"],function(e,n){return n.extend({declare:["address"],initialize:function(){void 0===this.address&&(this.address=e.uuid())}})}),define("sync/Member",["common/Util","common/Events","data/Model","data/Operation","sync/channel/MemberEndpoint","sync/channel/Message"],function(e,n,t,r,i,o){return n.extend({initialize:function(){var n=this.endpoint=new r({transformer:options.transformer}),i=this.model=new t,o=this;this.handlers={},this.name||(this.name=e.uuid()),n.on("inbound",function(e){for(var n=e.operations,t=0;t<n.length;t++)i.evaluate(n[t]),o.trigger("all",n[t].pointer,n[t].command)})},evaluate:function(e,n){this.model.evaluate(e,n);var t=new i({member:this.name,memberTime:this.clock.tick(),leaderTime:this.endpoint.getRemoteTime(),operations:[new o({pointer:e,command:n})]});this.endpoint.send(t)},find:function(e,n){return this.model.find(e,n)},getEndpoint:function(){return this.endpoint}})}),define("data/command/Construct",["data/Command"],function(e){return e.extend({declare:["type"],initialize:function(){this.type||(this.type="HASH")}})}),define("data/command/Delete",["data/Command"],function(e){return e.extend({declare:["offset"]})}),define("data/command/Destruct",["data/Command"],function(e){return e.extend()}),define("data/command/Insert",["data/Command"],function(e){return e.extend({declare:["offset","data"]})}),define("data/command/Nil",["data/Command"],function(e){return e.extend()}),define("data/command/NIL",["data/command/Nil"],function(e){return new e}),define("data/command/Set",["data/Command"],function(e){return e.extend({declare:["identifier","data"]})}),define("data/command/Unset",["data/Command"],function(e){return e.extend({declare:["identifier"]})}),define("sync/channel/Endpoint",["common/Events","sync/time/after","sync/transform/Transformer"],function(e,n,t){var r=function(){throw new Error("UnimplementedFunction")};return e.extend({declare:["remoteTime","queue"],initialize:function(){this.queue=[],this.remoteTime=0,this.transformer||(this.transformer=new t)},receive:function(e){var t=this.queue;try{for(;t.length>0&&!n(this.getLocalTime(t[0]),this.getLocalTime(e));)t.shift();for(var r,i=0;i<t.length;i++)r=t[i],this.transformer.transform(e.operations,r.operations,e.member>r.member),this.setRemoteTime(r,this.getRemoteTime(e)),this.setLocalTime(e,this.getLocalTime(r));this.remoteTime=this.getRemoteTime(e),this.trigger("inbound",e)}catch(e){throw new Error("ChannelException")}return this},send:function(e){if(this.getRemoteTime(e)!=this.remoteTime)throw new Error("SynchronicityException");return this.queue.push(e),this.trigger("outbound",e),this},setRemoteTime:r,setLocalTime:r,getRemoteTime:r,getLocalTime:r})}),define("sync/channel/MemberEndpoint",["sync/channel/Endpoint"],function(e){return e.extend({setRemoteTime:function(e,n){e.leaderTime=n},setLocalTime:function(e,n){e.memberTime=n},getRemoteTime:function(e){return e.leaderTime},getLocalTime:function(e){return e.memberTime}})}),define("sync/channel/Message",["common/Contract"],function(e){return e.extend({declare:["member","memberTime","leaderTime","operations"],initialize:function(){}})}),define("sync/time/after",["sync/time/CONST"],function(e){return function(n,t){if(n>t){var r=n-t,i=e.LOGICAL_HOUR-n+t;if(Math.min(r,i)>e.CERTAINTY_MARGIN)throw new Error("UncertainTemporalRelation");return r<i}if(n<t){var r=t-n,i=e.LOGICAL_HOUR-t+n;if(Math.min(r,i)>e.CERTAINTY_MARGIN)throw new Error("UncertainTemporalRelation");return i<r}return!1}}),define("sync/time/Clock",["sync/time/CONST"],function(e){var n=function(e){this.time=e||0};return n.prototype.tick=function(){return this.time<e.LOGICAL_HOUR-1?++this.time:this.time=0},n.prototype.setTime=function(e){this.time=e},n.prototype.getTime=function(e){return this.time},n}),define("sync/time/CONST",function(){var e=Math.pow(2,24);return{LOGICAL_HOUR:e,CERTAINTY_MARGIN:e/100}}),define("sync/transform/Inclusion",["common/Contract"],function(e){return e.extend({canInclude:function(){return!1}})}),define("sync/transform/Inclusions",["exports","sync/transform/Inclusion","data/command/Insert","data/command/Delete","data/command/Set","data/command/Unset","data/command/Construct","data/command/Destruct","data/command/NIL"],function(e,n,t,r,i,o,a,c,s){var f=e.InsertInsert=n.extend({canInclude:function(e,n){return e instanceof t&&n instanceof t},include:function(e,n,r){return e.offset>n.offset||e.offset===n.offset&&r?new t({offset:e.offset+1,data:e.data}):e}}),d=e.InsertDelete=n.extend({canInclude:function(e,n){return e instanceof t&&n instanceof r},include:function(e,n,r){return e.offset>n.offset?new t({offset:e.offset-1,data:e.data}):e}}),u=e.DeleteInsert=n.extend({canInclude:function(e,n){return e instanceof r&&n instanceof t},include:function(e,n,t){return e.offset>=n.offset?new r({offset:e.offset+1}):e}}),m=e.DeleteDelete=n.extend({canInclude:function(e,n){return x1 instanceof r&&n instanceof r},include:function(e,n,t){return e.offset===n.offset?s:e.offset>n.offset?new r({offset:e.offset-1}):e}}),l=e.SetSet=n.extend({canInclude:function(e,n){return e instanceof i&&n instanceof i},include:function(e,n,t){return e.identifier===n.identifier&&t?s:e}}),h=e.SetUnset=n.extend({canInclude:function(e,n){return e instanceof i&&n instanceof o},include:function(e,n,t){return e}}),p=e.UnsetSet=n.extend({canInclude:function(e,n){return e instanceof o&&n instanceof i},include:function(e,n,t){return e.identifier===n.identifier?s:e}}),y=e.UnsetUnset=n.extend({canInclude:function(e,n){return e instanceof o&&n instanceof o},include:function(e,n,t){return e.identifier===n.identifier?s:e}}),x=e.NilNil=n.extend({canInclude:function(e,n){return e instanceof Nil||n instanceof Nil},include:function(e,n,t){return e}});e.ALL=[new f,new m,new u,new d,new l,new y,new h,new p,new x]}),define("sync/transform/Transformer",["sync/transform/Inclusions"],function(e){var n=function(n){this.transformers=n||e.ALL};return n.prototype.transform=function(e,n,t){for(var r=e.slice(),i=0;i<e.length;i++)for(var o=0;o<n.length;o++)((null===e[i].pointer||void 0===e[i].pointer)&&(null==n[o].pointer||void 0===n[o].pointer)||null!=e[i].pointer&&e[i].pointer.equals(n[o].pointer))&&(e[i].command=this.include(e[i].command,n[o].command,t),n[o].command=this.include(n[o].command,r[i].command,!t))},n.prototype.include=function(e,n,t){for(var r,i=0;i<this.transformers.length;i++){var r=this.transformers[i];if(r.canInclude(e,n))return r.include(e,n,t)}throw new Error("TransformationUndefinedException")},n});
//# sourceMappingURL=march.min.js.map
